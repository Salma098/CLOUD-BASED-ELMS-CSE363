version: "3.8"
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8000:8000"
    env_file:
      - infra/env/dev.env
    environment:
      SERVICE_NAME: api-gateway
      STORAGE_ROOT: /app/storage
      S3_ENABLED: ${S3_ENABLED:-0}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      TTS_SERVICE_URL: http://tts-service:8001
      STT_SERVICE_URL: http://stt-service:8002
      CHAT_SERVICE_URL: http://chat-service:8003
      DOCUMENT_SERVICE_URL: http://document-service:8004
      QUIZ_SERVICE_URL: http://quiz-service:8005
    depends_on:
      kafka:
        condition: service_healthy
      chat-service:
        condition: service_started
      document-service:
        condition: service_started
      tts-service:
        condition: service_started
      stt-service:
        condition: service_started
      quiz-service:
        condition: service_started
    volumes:
      - api_gateway_data:/app/storage
    networks:
      - microservices-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "80:80"
    depends_on:
      - api-gateway
    networks:
      - microservices-network
    restart: unless-stopped

  chat-service:
    build:
      context: ./chat-service
    container_name: chat-service
    ports:
      - "8003:8003"
    env_file:
      - infra/env/dev.env
    environment:
      SERVICE_NAME: chat-service
      STORAGE_ROOT: /app/storage
      S3_ENABLED: ${S3_ENABLED:-0}
      S3_BUCKET: ${CHAT_BUCKET:-cse363-chat-service-storage}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      AI_MODEL: gpt-4o-mini
      KAFKA_BOOTSTRAP: kafka:9092
    volumes:
      - chat_data:/app/storage
    networks:
      - microservices-network
    depends_on:
      kafka:
        condition: service_healthy
    restart: on-failure:5  # Restart up to 5 times if it fails

  document-service:
    build:
      context: ./document-service
    container_name: document-service
    ports:
      - "8004:8004"
    env_file:
      - infra/env/dev.env
    environment:
      SERVICE_NAME: document-service
      STORAGE_ROOT: /app/storage
      S3_ENABLED: ${S3_ENABLED:-0}
      S3_BUCKET: ${DOCUMENT_BUCKET:-cse363-docreader-service-storage}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      KAFKA_BOOTSTRAP: kafka:9092
    volumes:
      - document_data:/app/storage
    networks:
      - microservices-network
    depends_on:
      kafka:
        condition: service_healthy
    restart: on-failure:5

  tts-service:
    build:
      context: ./tts-service
    container_name: tts-service
    ports:
      - "8001:8001"
    env_file:
      - infra/env/dev.env
    environment:
      SERVICE_NAME: tts-service
      STORAGE_ROOT: /app/storage
      S3_ENABLED: ${S3_ENABLED:-0}
      S3_BUCKET: ${TTS_BUCKET:-cse363-tts-service-storage}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      KAFKA_BOOTSTRAP: kafka:9092
    volumes:
      - tts_data:/app/storage
    networks:
      - microservices-network
    depends_on:
      kafka:
        condition: service_healthy
    restart: on-failure:5

  stt-service:
    build:
      context: ./stt-service
    container_name: stt-service
    ports:
      - "8002:8002"
    env_file:
      - infra/env/dev.env
    environment:
      SERVICE_NAME: stt-service
      STORAGE_ROOT: /app/storage
      S3_ENABLED: ${S3_ENABLED:-0}
      S3_BUCKET: ${STT_BUCKET:-cse363-stt-service-storage}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      KAFKA_BOOTSTRAP: kafka:9092
    volumes:
      - stt_data:/app/storage
    networks:
      - microservices-network
    depends_on:
      kafka:
        condition: service_healthy
    restart: on-failure:5

  quiz-service:
    build:
      context: ./quiz-service
    container_name: quiz-service
    ports:
      - "8005:8005"
    env_file:
      - infra/env/dev.env
    environment:
      SERVICE_NAME: quiz-service
      STORAGE_ROOT: /app/storage
      S3_ENABLED: ${S3_ENABLED:-0}
      S3_BUCKET: ${QUIZ_BUCKET:-cse363-quiz-service-storage}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      KAFKA_BOOTSTRAP: kafka:9092
    volumes:
      - quiz_data:/app/storage
    networks:
      - microservices-network
    depends_on:
      kafka:
        condition: service_healthy
    restart: on-failure:5

volumes:
  api_gateway_data:
  chat_data:
  document_data:
  tts_data:
  stt_data:
  quiz_data:

networks:
  microservices-network:
    driver: bridge